#!/bin/sh
# <UDF name="FQDN" label="The hostname for the new Linode." />
# <UDF name="AWS_ACCESS_KEY_ID" Label="AWS API Key ID" />
# <UDF name="AWS_SECRET_ACCESS_KEY" Label="AWS Secret Access Key" />
# <UDF name="AWS_REGION" Label="AWS Region" />
# <UDF name="MYSQL_ROOT_PASSWORD" Label="MySQL root user password" />
# <UDF name="MYSQL_PORT" Label="MySQL port" />
# <UDF name="MYSQL_DATABASE" Label="MySQL database schema name" />
# <UDF name="ALLOWED_IP_ADDRESSES" Label="MySQL allowed_ip_addresses" />
set -ex
exec >/root/stackscript.log 2>&1
echo "Linode Variable Values:  LINODE_ID: $LINODE_ID,  LINODE_LISHUSERNAME: $LINODE_LISHUSERNAME,  LINODE_RAM: $LINODE_RAM,  LINODE_DATACENTERID:$LINODE_DATACENTERID"
source <ssinclude StackScriptID="929970">

function add_packages() {
    echo "Adding packages..."
    apk add --update ca-certificates openssl lsof
    update-ca-certificates --fresh
}
function setup_aws() {
    install_awscli
    echo "Setup awscli..."
    mkdir ~/.aws
  cat > ~/.aws/config <<CONFIG
[default]
region = ${AWS_REGION}
CONFIG
  cat > ~/.aws/credentials <<CREDS
[default]
aws_access_key_id = ${AWS_ACCESS_KEY_ID}
aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
CREDS
    # Test AWS Credentials stored in Env vars
    echo $(aws sts get-caller-identity)
}
function mysql_configure() {
    echo "Configuring mysql..."
    local memory_allocate_percent=${1:-90}
    local conf_path=${2:-/etc/my.cnf.d/custom.cnf}
    local mem="$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)" # how much memory in MB this system has
    local mymem="$((mem*memory_allocate_percent/100))" # how much memory we'd like to tune mysql with
    local mymemchunks="$((mymem/4))" # how many 4MB chunks we have to play with
    echo -e "skip-host-cache\nskip-name-resolve\nserver-id = 1\nlog_bin = /var/log/mysql/mysql-bin.log\nbinlog_format = ROW\nbinlog_do_db = ${MYSQL_DATABASE}" >> ${conf_path}
    # mysql config options we want to set to the percentages in the second list, respectively
    key_buffer=$(echo | awk "{print int((75 * ${mymemchunks}/100))*4}")
    query_cache=$(echo | awk "{print int((15 * ${mymemchunks}/100))*4}")
    myisam_sort_buffer=$(echo | awk "{print int((5 * ${mymemchunks}/100))*4}")
    echo "key_buffer_size         = ${key_buffer}M" >> ${conf_path}
    echo "query_cache_size        = ${query_cache}M" >> ${conf_path}
    echo "myisam_sort_buffer_size = ${myisam_sort_buffer}M" >> ${conf_path}
    remaining=$(echo | awk "{print int((1 * ${mymemchunks}/100))*4}")
    [ ${remaining} -lt 8 ] && remaining=8
    echo "sort_buffer_size     = ${remaining}M" >> ${conf_path}
    echo "read_buffer_size     = ${remaining}M" >> ${conf_path}
    echo "read_rnd_buffer_size = ${remaining}M" >> ${conf_path}
    rc-service mariadb restart
    netstat -ltn

}
function configure_allowed_ip_addresses() {
    apk -q add --update iptables
    rc-update add iptables default
    for i in $ALLOWED_IP_ADDRESSES; do
        iptables -A INPUT -p tcp -s ${i} --sport 1024:65535 -d ${system_primary_ip} --dport ${MYSQL_PORT} -m state --state NEW,ESTABLISHED -j ACCEPT
        iptables -A OUTPUT -p tcp -s ${system_primary_ip} --sport ${MYSQL_PORT} -d ${i} --dport 1024:65535 -m state --state ESTABLISHED -j ACCEPT

    done
    iptables -nvL
}
function install() {
    setup_swap ${LINODE_RAM}
    setup_hostname ${FQDN}
    setup_timezone UTC
    harden_ssh
    enable_fail2ban
    patch_os
    enable_auto_updates
    add_packages
    setup_aws
    mysql_install ${MYSQL_ROOT_PASSWORD}
    mysql_configure
    setup_firewall
    open_firewall_port 22
    open_firewall_port ${MYSQL_PORT}
    configure_allowed_ip_addresses
    echo "Stackscript finished"

}

echo "Setup PATH..."
echo 'export PATH="$PATH:/root/.local/bin"' >> ~/.bashrc
export PATH="$PATH:/root/.local/bin"
install
rc-status
stackscript_cleanup
echo $(date +'%F') > /root/.deployed
echo "Installation complete!"
